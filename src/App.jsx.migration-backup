import React, { useState, useEffect } from 'react';
import { Calendar, Users, BookOpen, CheckSquare, MapPin, UserCheck, Settings, Home, Bell, Search, Download, Upload, Plus, Edit2, Trash2, Eye, EyeOff, LogOut, KeyRound, Filter, X, Save, ChevronDown, ChevronRight, Clock, Mail, Phone, Award, Activity, Copy, FileUp, FileDown, AlertCircle } from 'lucide-react';
import Papa from 'papaparse';
import { useAuth } from './auth/AuthContext.jsx';
import { hasPermission } from './auth/permissions.js';
import { getAllUsers, createUser, updateUser, resetPassword, unlockAccount } from './auth/service.js';
import { readAudit } from './auth/db.js';
import { ReadOnlyBanner } from './auth/RequirePermission.jsx';
import './App.css';

// Helper functions
const toInitials = (name = '') => name
  .split(' ')
  .filter(Boolean)
  .slice(0, 2)
  .map((part) => part[0].toUpperCase())
  .join('') || 'YM';

// Custom hook for localStorage persistence
function useLocalStorage(key, initialValue) {
  const [value, setValue] = useState(() => {
    try {
      const saved = localStorage.getItem(key);
      return saved ? JSON.parse(saved) : initialValue;
    } catch (error) {
      console.error(`Error loading ${key} from localStorage:`, error);
      return initialValue;
    }
  });

  useEffect(() => {
    try {
      localStorage.setItem(key, JSON.stringify(value));
    } catch (error) {
      console.error(`Error saving ${key} to localStorage:`, error);
    }
  }, [key, value]);

  return [value, setValue];
}

// Initial data structure based on the Excel file
const initialStudents = [
  {
    id: 1,
    firstName: 'Abanob',
    lastName: 'Bakheet',
    grade: '9th',
    phone: '951-429-2464',
    email: '',
    dob: '2010-08-05',
    responsibleServant: 'Mariam',
    status: 'Active',
    parent1Name: '',
    parent1Phone: '',
    parent1Email: '',
    parent2Name: '',
    parent2Phone: '',
    parent2Email: '',
    address: '',
    city: '',
    zipcode: ''
  },
  {
    id: 2,
    firstName: 'Abigail',
    lastName: 'Malak',
    grade: '10th',
    phone: '',
    email: '',
    dob: '',
    responsibleServant: 'Mariam',
    status: 'Active',
    parent1Name: '',
    parent1Phone: '',
    parent1Email: '',
    parent2Name: '',
    parent2Phone: '',
    parent2Email: '',
    address: '',
    city: '',
    zipcode: ''
  },
  {
    id: 3,
    firstName: 'Alexandra',
    lastName: 'Gerges',
    grade: '11th',
    phone: '',
    email: '',
    dob: '2008-08-22',
    responsibleServant: 'Mariam',
    status: 'Active',
    parent1Name: '',
    parent1Phone: '',
    parent1Email: '',
    parent2Name: '',
    parent2Phone: '',
    parent2Email: '',
    address: '',
    city: '',
    zipcode: ''
  },
  {
    id: 4,
    firstName: 'Andrew',
    lastName: 'Nabil',
    grade: '12th',
    phone: '',
    email: '',
    dob: '2009-07-28',
    responsibleServant: 'Nancy',
    status: 'Active',
    parent1Name: '',
    parent1Phone: '',
    parent1Email: '',
    parent2Name: '',
    parent2Phone: '',
    parent2Email: '',
    address: '',
    city: '',
    zipcode: ''
  },
  {
    id: 5,
    firstName: 'Angela',
    lastName: 'Moawad',
    grade: '9th',
    phone: '',
    email: '',
    dob: '2008-09-22',
    responsibleServant: 'Veronia',
    status: 'Active',
    parent1Name: '',
    parent1Phone: '',
    parent1Email: '',
    parent2Name: '',
    parent2Phone: '',
    parent2Email: '',
    address: '',
    city: '',
    zipcode: ''
  },
];

const initialAttendance = [];

const initialCourses = [
  { id: 1, name: 'Dogma 1', category: 'Theology' },
  { id: 2, name: 'Dogma 2', category: 'Theology' },
  { id: 3, name: 'Spirituality', category: 'Spiritual Life' },
  { id: 4, name: 'Liturgical Studies', category: 'Worship' },
  { id: 5, name: 'Patristics', category: 'Church Fathers' },
  { id: 6, name: 'Apologetics', category: 'Apologetics' },
  { id: 7, name: 'New Testament', category: 'Scripture' },
  { id: 8, name: 'Old Testament', category: 'Scripture' },
  { id: 9, name: 'Church History', category: 'History' },
  { id: 10, name: 'Comparative Religion', category: 'Comparative' },
];

const YouthMinistryApp = () => {
  // Use auth from context instead of local state
  const { currentUser, logout: handleLogout } = useAuth();

  const [currentView, setCurrentView] = useState('dashboard');
  const [students, setStudents] = useLocalStorage('yms_students', initialStudents);
  const [attendance, setAttendance] = useLocalStorage('yms_attendance', initialAttendance);
  const [selectedStudent, setSelectedStudent] = useState(null);
  const [showModal, setShowModal] = useState(false);
  const [searchTerm, setSearchTerm] = useState('');
  const [filterGrade, setFilterGrade] = useState('all');
  const [attendanceDate, setAttendanceDate] = useState(new Date().toISOString().split('T')[0]);
  const [serviceRotations, setServiceRotations] = useLocalStorage('yms_serviceRotations', []);
  const [visitations, setVisitations] = useLocalStorage('yms_visitations', []);
  const [teachingSchedule, setTeachingSchedule] = useLocalStorage('yms_teachingSchedule', []);
  const [courseProgress, setCourseProgress] = useLocalStorage('yms_courseProgress', []);

  useEffect(() => {
    const users = readUsers();
    const sessions = readSessions();
    const activeToken = localStorage.getItem(ACTIVE_SESSION_KEY);

    if (!users.length) {
      setAuthMode('setup');
      return;
    }

    if (activeToken) {
      const activeSession = sessions.find((session) => session.sessionToken === activeToken);
      if (activeSession && isSessionActive(activeSession)) {
        const user = users.find((item) => item.id === activeSession.userId && item.isActive);
        if (user) {
          setCurrentUser(user);
          setAuthMode('app');
          return;
        }
      }
    }

    setAuthMode('login');
  }, []);

  useEffect(() => {
    if (authMode !== 'app' || !currentUser) return undefined;

    const intervalId = setInterval(() => {
      const sessions = readSessions();
      const activeToken = localStorage.getItem(ACTIVE_SESSION_KEY);
      const activeSession = sessions.find((session) => session.sessionToken === activeToken);

      if (!activeSession || !isSessionActive(activeSession)) {
        handleLogout();
      }
    }, 60 * 1000);

    return () => clearInterval(intervalId);
  }, [authMode, currentUser]);

  const createSessionForUser = (userId, remember) => {
    const sessions = readSessions().filter((session) => isSessionActive(session));
    const expiresAt = remember ? addDays(AUTH_REMEMBER_DAYS) : addMinutes(AUTH_SESSION_MINUTES);
    const session = {
      id: Date.now(),
      userId,
      sessionToken: generateToken(),
      expiresAt,
      createdAt: nowIso()
    };

    writeSessions([...sessions, session]);
    localStorage.setItem(ACTIVE_SESSION_KEY, session.sessionToken);
    return session;
  };

  const logAudit = (action, detail, actor = currentUser) => {
    appendAudit({
      id: Date.now(),
      timestamp: nowIso(),
      actorId: actor?.id || null,
      actorName: actor?.fullName || actor?.username || 'System',
      action,
      detail
    });
  };

  const handleLogout = () => {
    if (currentUser) {
      logAudit('Logout', `User ${currentUser.username} logged out.`, currentUser);
    }
    const activeToken = localStorage.getItem(ACTIVE_SESSION_KEY);
    if (activeToken) {
      const sessions = readSessions().filter((session) => session.sessionToken !== activeToken);
      writeSessions(sessions);
    }
    localStorage.removeItem(ACTIVE_SESSION_KEY);
    setCurrentUser(null);
    setAuthMode('login');
  };

  const handleSetup = async (payload) => {
    setAuthBusy(true);
    setAuthError('');
    try {
      const users = readUsers();
      if (users.length) {
        setAuthMode('login');
        return;
      }

      if (payload.password.length < 8 || !/[0-9]/.test(payload.password) || !/[A-Za-z]/.test(payload.password)) {
        setAuthError('Password must be at least 8 characters and include letters and numbers.');
        return;
      }

      if (payload.password !== payload.confirmPassword) {
        setAuthError('Passwords do not match.');
        return;
      }

      const passwordHash = await hashPassword(payload.password);
      const newUser = {
        id: Date.now(),
        username: normalizeUsername(payload.username),
        passwordHash,
        fullName: payload.fullName.trim(),
        email: payload.email.trim(),
        role: 'admin',
        isActive: true,
        createdAt: nowIso(),
        updatedAt: nowIso(),
        failedAttempts: 0,
        lockedUntil: null
      };

      writeUsers([newUser]);
      createSessionForUser(newUser.id, true);
      logAudit('Setup', `Initial admin account created (${newUser.username}).`, newUser);
      setCurrentUser(newUser);
      setAuthMode('app');
    } catch (error) {
      console.error('Setup failed', error);
      setAuthError(formatAuthError());
    } finally {
      setAuthBusy(false);
    }
  };

  const handleLogin = async ({ username, password, remember }) => {
    setAuthBusy(true);
    setAuthError('');
    try {
      const users = readUsers();
      const normalized = normalizeUsername(username);
      const index = users.findIndex((user) => user.username === normalized);

      if (index === -1) {
        setAuthError('Invalid username or password.');
        return;
      }

      const user = users[index];
      if (!user.isActive) {
        setAuthError('Account is inactive. Contact an administrator.');
        return;
      }

      if (user.lockedUntil && new Date(user.lockedUntil).getTime() > Date.now()) {
        setAuthError('Account locked due to failed attempts. Please try again later.');
        return;
      }

      const passwordHash = await hashPassword(password);
      if (passwordHash !== user.passwordHash) {
        const attempts = (user.failedAttempts || 0) + 1;
        const updatedUser = {
          ...user,
          failedAttempts: attempts,
          lockedUntil: attempts >= 5 ? addMinutes(AUTH_LOCKOUT_MINUTES) : user.lockedUntil,
          updatedAt: nowIso()
        };
        users[index] = updatedUser;
        writeUsers(users);
        setAuthError('Invalid username or password.');
        return;
      }

      const updatedUser = {
        ...user,
        failedAttempts: 0,
        lockedUntil: null,
        lastLogin: nowIso(),
        updatedAt: nowIso()
      };
      users[index] = updatedUser;
      writeUsers(users);
      createSessionForUser(updatedUser.id, remember);
      logAudit('Login', `User ${updatedUser.username} logged in.`, updatedUser);
      setCurrentUser(updatedUser);
      setAuthMode('app');
    } catch (error) {
      console.error('Login failed', error);
      setAuthError(formatAuthError());
    } finally {
      setAuthBusy(false);
    }
  };

  const role = currentUser?.role || 'viewer';
  const canEdit = role === 'admin' || role === 'servant';
  const canDelete = role === 'admin';
  const canImport = canEdit;
  const canManageUsers = role === 'admin';

  // Calculate statistics
  const calculateAttendancePercentage = () => {
    const activeStudents = students.filter(s => s.status === 'Active');
    if (activeStudents.length === 0 || attendance.length === 0) return 0;

    // Get unique dates to calculate attendance per session
    const uniqueDates = [...new Set(attendance.map(a => a.date))];
    if (uniqueDates.length === 0) return 0;

    // Calculate attendance percentage across all sessions
    const totalPossibleAttendances = activeStudents.length * uniqueDates.length;
    const actualAttendances = attendance.filter(a => {
      const student = students.find(s => s.id === a.studentId);
      return student && student.status === 'Active' && a.present;
    }).length;

    return Math.round((actualAttendances / totalPossibleAttendances) * 100);
  };

  const stats = {
    totalStudents: students.filter(s => s.status === 'Active').length,
    totalGraduates: students.filter(s => s.status === 'Graduate').length,
    averageAttendance: calculateAttendancePercentage(),
    upcomingVisits: visitations.filter(v => !v.completed).length,
  };

  // Filter students
  const filteredStudents = students.filter(student => {
    const matchesSearch = `${student.firstName} ${student.lastName}`.toLowerCase().includes(searchTerm.toLowerCase());
    const matchesGrade = filterGrade === 'all' || student.grade === filterGrade;
    return matchesSearch && matchesGrade;
  });

  // Attendance marking
  const markAttendance = (studentId, present) => {
    if (!canEdit) return;
    const newRecord = {
      id: Date.now(),
      studentId,
      date: attendanceDate,
      present,
      day: new Date(attendanceDate).toLocaleDateString('en-US', { weekday: 'short' })
    };
    setAttendance([...attendance, newRecord]);
  };

  // Student CRUD operations
  const addStudent = (studentData) => {
    if (!canEdit) return;
    setStudents([...students, { ...studentData, id: Date.now() }]);
    setShowModal(false);
  };

  const updateStudent = (id, studentData) => {
    if (!canEdit) return;
    setStudents(students.map(s => s.id === id ? { ...s, ...studentData } : s));
    setShowModal(false);
    setSelectedStudent(null);
  };

  const deleteStudent = (id) => {
    if (!canDelete) return;
    if (confirm('Are you sure you want to delete this student?')) {
      setStudents(students.filter(s => s.id !== id));
    }
  };

  // Component: Dashboard
  const Dashboard = () => {
    // Grade distribution
    const gradeDistribution = {
      '9th': students.filter(s => s.status === 'Active' && s.grade === '9th').length,
      '10th': students.filter(s => s.status === 'Active' && s.grade === '10th').length,
      '11th': students.filter(s => s.status === 'Active' && s.grade === '11th').length,
      '12th': students.filter(s => s.status === 'Active' && s.grade === '12th').length,
    };

    // Recent activities from actual data
    const recentActivities = [];

    // Recent attendance sessions
    const uniqueDates = [...new Set(attendance.map(a => a.date))].sort((a, b) => new Date(b) - new Date(a));
    if (uniqueDates.length > 0) {
      const latestDate = uniqueDates[0];
      const dayName = new Date(latestDate).toLocaleDateString('en-US', { weekday: 'long' });
      recentActivities.push({
        icon: CheckSquare,
        text: `Attendance marked for ${dayName}`,
        time: formatRelativeTime(latestDate)
      });
    }

    // Recent students
    const recentStudents = [...students].sort((a, b) => b.id - a.id).slice(0, 1);
    if (recentStudents.length > 0) {
      recentActivities.push({
        icon: Users,
        text: `Student added: ${recentStudents[0].firstName} ${recentStudents[0].lastName}`,
        time: 'Recently'
      });
    }

    // Recent completed visitations
    const completedVisits = visitations.filter(v => v.completed).sort((a, b) => new Date(b.date) - new Date(a.date)).slice(0, 1);
    if (completedVisits.length > 0) {
      const student = students.find(s => s.id === completedVisits[0].studentId);
      if (student) {
        recentActivities.push({
          icon: MapPin,
          text: `Visitation completed: ${student.firstName} ${student.lastName}`,
          time: formatRelativeTime(completedVisits[0].date)
        });
      }
    }

    function formatRelativeTime(dateStr) {
      const date = new Date(dateStr);
      const now = new Date();
      const diffMs = now - date;
      const diffDays = Math.floor(diffMs / (1000 * 60 * 60 * 24));

      if (diffDays === 0) return 'Today';
      if (diffDays === 1) return 'Yesterday';
      if (diffDays < 7) return `${diffDays} days ago`;
      if (diffDays < 30) return `${Math.floor(diffDays / 7)} weeks ago`;
      return date.toLocaleDateString();
    }

    return (
      <div className="dashboard-grid">
        <div className="stat-card stat-primary">
          <div className="stat-icon"><Users size={32} /></div>
          <div className="stat-content">
            <div className="stat-label">Active Students</div>
            <div className="stat-value">{stats.totalStudents}</div>
            <div className="stat-detail">
              {Object.entries(gradeDistribution).map(([grade, count]) => (
                count > 0 && <span key={grade}>{grade}: {count}</span>
              )).filter(Boolean).slice(0, 2).reduce((prev, curr) => [prev, ' â€¢ ', curr])}
            </div>
          </div>
        </div>

        <div className="stat-card stat-secondary">
          <div className="stat-icon"><Award size={32} /></div>
          <div className="stat-content">
            <div className="stat-label">Graduates</div>
            <div className="stat-value">{stats.totalGraduates}</div>
            <div className="stat-detail">This year</div>
          </div>
        </div>

        <div className="stat-card stat-accent">
          <div className="stat-icon"><Activity size={32} /></div>
          <div className="stat-content">
            <div className="stat-label">Avg Attendance</div>
            <div className="stat-value">{stats.averageAttendance}%</div>
            <div className="stat-detail">{uniqueDates.length} sessions tracked</div>
          </div>
        </div>

        <div className="stat-card stat-warning">
          <div className="stat-icon"><MapPin size={32} /></div>
          <div className="stat-content">
            <div className="stat-label">Pending Visits</div>
            <div className="stat-value">{stats.upcomingVisits}</div>
            <div className="stat-detail">{visitations.filter(v => v.completed).length} completed</div>
          </div>
        </div>

        <div className="dashboard-section recent-activity">
          <h2>Recent Activity</h2>
          <div className="activity-list">
            {recentActivities.length > 0 ? (
              recentActivities.map((activity, index) => (
                <div key={index} className="activity-item">
                  <activity.icon size={16} />
                  <span>{activity.text}</span>
                  <span className="activity-time">{activity.time}</span>
                </div>
              ))
            ) : (
              <div className="empty-activity">
                <Clock size={32} />
                <p>No recent activity</p>
              </div>
            )}
          </div>
        </div>

        <div className="dashboard-section quick-actions">
          <h2>Quick Actions</h2>
          <div className="action-buttons">
            <button className="action-btn" onClick={() => setCurrentView('attendance')}>
              <CheckSquare size={20} />
              Mark Attendance
            </button>
            <button className="action-btn" onClick={() => { setShowModal(true); setSelectedStudent(null); }}>
              <Plus size={20} />
              Add Student
            </button>
            <button className="action-btn" onClick={() => setCurrentView('visitations')}>
              <MapPin size={20} />
              Schedule Visit
            </button>
            <button className="action-btn" onClick={() => setCurrentView('import')}>
              <Upload size={20} />
              Import/Export Data
            </button>
          </div>
        </div>
      </div>
    );
  };

  // Component: Students Management
  const StudentsView = () => (
    <div className="content-section">
      <div className="section-header">
        <h1>Students Management</h1>
        {canEdit && (
          <button className="btn-primary" onClick={() => { setShowModal(true); setSelectedStudent(null); }}>
            <Plus size={18} /> Add Student
          </button>
        )}
      </div>

      {!canEdit && <ReadOnlyNotice />}

      <div className="filters-bar">
        <div className="search-box">
          <Search size={18} />
          <input
            type="text"
            placeholder="Search students..."
            value={searchTerm}
            onChange={(e) => setSearchTerm(e.target.value)}
          />
        </div>
        
        <select value={filterGrade} onChange={(e) => setFilterGrade(e.target.value)} className="filter-select">
          <option value="all">All Grades</option>
          <option value="9th">9th Grade</option>
          <option value="10th">10th Grade</option>
          <option value="11th">11th Grade</option>
          <option value="12th">12th Grade</option>
        </select>
      </div>

      <div className="students-grid">
        {filteredStudents.map(student => (
          <div key={student.id} className="student-card">
            <div className="student-header">
              <div className="student-avatar">
                {student.firstName[0]}{student.lastName[0]}
              </div>
              <div className="student-info">
                <div style={{ display: 'flex', alignItems: 'center', gap: '0.5rem' }}>
                  <h3>{student.firstName} {student.lastName}</h3>
                  <span className={`status-badge status-${student.status?.toLowerCase() || 'active'}`}>
                    {student.status || 'Active'}
                  </span>
                </div>
                <p className="student-grade">{student.grade}</p>
              </div>
            </div>

            <div className="student-details">
              {student.phone && (
                <div className="detail-row">
                  <Phone size={14} />
                  <span>{student.phone}</span>
                </div>
              )}
              {student.email && (
                <div className="detail-row">
                  <Mail size={14} />
                  <span>{student.email}</span>
                </div>
              )}
              <div className="detail-row">
                <UserCheck size={14} />
                <span>{student.responsibleServant}</span>
              </div>
              {student.parent1Name && (
                <div className="detail-row" style={{ marginTop: '0.5rem', paddingTop: '0.5rem', borderTop: '1px solid var(--border)' }}>
                  <Users size={14} />
                  <span style={{ fontSize: '0.8rem' }}>{student.parent1Name}</span>
                </div>
              )}
              {student.address && (
                <div className="detail-row">
                  <MapPin size={14} />
                  <span style={{ fontSize: '0.8rem' }}>{student.city || student.address}</span>
                </div>
              )}
            </div>
            
            <div className="student-actions">
              <button className="icon-btn" onClick={() => { setSelectedStudent(student); setCurrentView('studentDetail'); }}>
                <Eye size={16} />
              </button>
              {canEdit && (
                <button className="icon-btn" onClick={() => { setSelectedStudent(student); setShowModal(true); }}>
                  <Edit2 size={16} />
                </button>
              )}
              {canDelete && (
                <button className="icon-btn danger" onClick={() => deleteStudent(student.id)}>
                  <Trash2 size={16} />
                </button>
              )}
            </div>
          </div>
        ))}
      </div>
    </div>
  );

  // Component: Attendance Tracking
  const AttendanceView = () => {
    const [selectedDay, setSelectedDay] = useState('Friday');
    const todayAttendance = attendance.filter(a => a.date === attendanceDate);

    const markAllPresent = () => {
      if (!canEdit) return;
      const activeStudents = students.filter(s => s.status === 'Active');
      const newRecords = activeStudents
        .filter(student => !todayAttendance.find(a => a.studentId === student.id))
        .map(student => ({
          id: Date.now() + student.id,
          studentId: student.id,
          date: attendanceDate,
          present: true,
          day: new Date(attendanceDate).toLocaleDateString('en-US', { weekday: 'short' })
        }));

      // Update existing records to present
      const updatedAttendance = attendance.map(a =>
        a.date === attendanceDate ? { ...a, present: true } : a
      );

      setAttendance([...updatedAttendance, ...newRecords]);
    };

    const markAllAbsent = () => {
      if (!canEdit) return;
      const activeStudents = students.filter(s => s.status === 'Active');
      const newRecords = activeStudents
        .filter(student => !todayAttendance.find(a => a.studentId === student.id))
        .map(student => ({
          id: Date.now() + student.id,
          studentId: student.id,
          date: attendanceDate,
          present: false,
          day: new Date(attendanceDate).toLocaleDateString('en-US', { weekday: 'short' })
        }));

      // Update existing records to absent
      const updatedAttendance = attendance.map(a =>
        a.date === attendanceDate ? { ...a, present: false } : a
      );

      setAttendance([...updatedAttendance, ...newRecords]);
    };

    const copyFromLastWeek = () => {
      if (!canEdit) return;
      const selectedDate = new Date(attendanceDate);
      const lastWeekDate = new Date(selectedDate);
      lastWeekDate.setDate(lastWeekDate.getDate() - 7);
      const lastWeekDateStr = lastWeekDate.toISOString().split('T')[0];

      const lastWeekAttendance = attendance.filter(a => a.date === lastWeekDateStr);

      if (lastWeekAttendance.length === 0) {
        alert('No attendance records found for last week on this date.');
        return;
      }

      const newRecords = lastWeekAttendance.map(record => ({
        id: Date.now() + record.studentId,
        studentId: record.studentId,
        date: attendanceDate,
        present: record.present,
        day: new Date(attendanceDate).toLocaleDateString('en-US', { weekday: 'short' })
      }));

      // Remove existing records for today and add copied ones
      const filteredAttendance = attendance.filter(a => a.date !== attendanceDate);
      setAttendance([...filteredAttendance, ...newRecords]);
    };

    return (
      <div className="content-section">
        <div className="section-header">
          <h1>Attendance Tracking</h1>
          <div className="attendance-controls">
            <input
              type="date"
              value={attendanceDate}
              onChange={(e) => setAttendanceDate(e.target.value)}
              className="date-input"
            />
            <div className="day-toggle">
              <button
                className={selectedDay === 'Friday' ? 'active' : ''}
                onClick={() => setSelectedDay('Friday')}
              >
                Friday
              </button>
              <button
                className={selectedDay === 'Saturday' ? 'active' : ''}
                onClick={() => setSelectedDay('Saturday')}
              >
                Saturday
              </button>
            </div>
          </div>
        </div>

        {!canEdit && <ReadOnlyNotice />}

        <div className="bulk-actions">
          <button className="bulk-btn" onClick={markAllPresent} disabled={!canEdit} aria-disabled={!canEdit}>
            <CheckSquare size={16} />
            Mark All Present
          </button>
          <button className="bulk-btn" onClick={markAllAbsent} disabled={!canEdit} aria-disabled={!canEdit}>
            <X size={16} />
            Mark All Absent
          </button>
          <button className="bulk-btn" onClick={copyFromLastWeek} disabled={!canEdit} aria-disabled={!canEdit}>
            <Copy size={16} />
            Copy from Last Week
          </button>
        </div>

        <div className="attendance-list">
          {students.filter(s => s.status === 'Active').map(student => {
            const hasRecord = todayAttendance.find(a => a.studentId === student.id);
            return (
              <div key={student.id} className="attendance-row">
                <div className="student-name-col">
                  <div className="student-avatar-sm">
                    {student.firstName[0]}{student.lastName[0]}
                  </div>
                  <div>
                    <div className="student-name">{student.firstName} {student.lastName}</div>
                    <div className="student-grade-sm">{student.grade}</div>
                  </div>
                </div>
                
                <div className="attendance-actions">
                  <button
                    className={`attendance-btn ${hasRecord?.present === true ? 'present' : ''}`}
                    onClick={() => markAttendance(student.id, true)}
                    disabled={!canEdit}
                    aria-disabled={!canEdit}
                  >
                    <CheckSquare size={18} />
                    Present
                  </button>
                  <button
                    className={`attendance-btn ${hasRecord?.present === false ? 'absent' : ''}`}
                    onClick={() => markAttendance(student.id, false)}
                    disabled={!canEdit}
                    aria-disabled={!canEdit}
                  >
                    <X size={18} />
                    Absent
                  </button>
                </div>
              </div>
            );
          })}
        </div>

        <div className="attendance-history-section">
          <h2>Attendance History</h2>
          <div className="history-stats">
            <div className="history-stat-card">
              <div className="stat-value">{[...new Set(attendance.map(a => a.date))].length}</div>
              <div className="stat-label">Total Sessions</div>
            </div>
            <div className="history-stat-card">
              <div className="stat-value">{attendance.filter(a => a.present).length}</div>
              <div className="stat-label">Total Present</div>
            </div>
            <div className="history-stat-card">
              <div className="stat-value">{attendance.filter(a => !a.present).length}</div>
              <div className="stat-label">Total Absent</div>
            </div>
          </div>

          <div className="history-timeline">
            {[...new Set(attendance.map(a => a.date))]
              .sort((a, b) => new Date(b) - new Date(a))
              .slice(0, 10)
              .map(date => {
                const sessionAttendance = attendance.filter(a => a.date === date);
                const presentCount = sessionAttendance.filter(a => a.present).length;
                const totalCount = sessionAttendance.length;
                const percentage = totalCount > 0 ? Math.round((presentCount / totalCount) * 100) : 0;

                return (
                  <div key={date} className="history-session">
                    <div className="session-date">
                      <Calendar size={16} />
                      <span>{new Date(date).toLocaleDateString('en-US', { weekday: 'short', year: 'numeric', month: 'short', day: 'numeric' })}</span>
                    </div>
                    <div className="session-stats">
                      <div className="session-count">
                        <span className="present-count">{presentCount} present</span>
                        <span className="absent-count">{totalCount - presentCount} absent</span>
                      </div>
                      <div className="session-percentage" style={{
                        color: percentage >= 80 ? 'var(--success)' : percentage >= 60 ? 'var(--warning)' : 'var(--danger)'
                      }}>
                        {percentage}%
                      </div>
                    </div>
                  </div>
                );
              })}
          </div>
        </div>
      </div>
    );
  };

  // Component: Servants Prep
  const ServantsPrep = () => {
    const [localSelectedStudent, setLocalSelectedStudent] = useState(null);

    const handleCourseStatusChange = (studentId, courseId, newStatus) => {
      if (!canEdit) return;
      const existingProgress = courseProgress.find(
        cp => cp.studentId === studentId && cp.courseId === courseId
      );

      if (existingProgress) {
        // Update existing progress
        setCourseProgress(
          courseProgress.map(cp =>
            cp.studentId === studentId && cp.courseId === courseId
              ? { ...cp, status: newStatus }
              : cp
          )
        );
      } else {
        // Add new progress
        setCourseProgress([
          ...courseProgress,
          { studentId, courseId, status: newStatus }
        ]);
      }
    };

    const getCourseStatus = (studentId, courseId) => {
      const progress = courseProgress.find(
        cp => cp.studentId === studentId && cp.courseId === courseId
      );
      return progress?.status || 'not-started';
    };

    return (
      <div className="content-section">
        <div className="section-header">
          <h1>Servants Preparation Program</h1>
        </div>

        {!canEdit && <ReadOnlyNotice />}

        <div className="prep-layout">
          <div className="students-sidebar">
            <h3>Students</h3>
            {students.filter(s => s.status === 'Active').map(student => (
              <div
                key={student.id}
                className={`sidebar-student ${localSelectedStudent?.id === student.id ? 'active' : ''}`}
                onClick={() => setLocalSelectedStudent(student)}
              >
                <div className="student-avatar-sm">
                  {student.firstName[0]}{student.lastName[0]}
                </div>
                <span>{student.firstName} {student.lastName}</span>
              </div>
            ))}
          </div>

          <div className="courses-content">
            {localSelectedStudent ? (
              <>
                <div className="selected-student-header">
                  <h2>{localSelectedStudent.firstName} {localSelectedStudent.lastName}</h2>
                  <p>Servants Preparation Progress</p>
                </div>

                <div className="courses-grid">
                  {initialCourses.map(course => {
                    const currentStatus = getCourseStatus(localSelectedStudent.id, course.id);
                    return (
                      <div key={course.id} className="course-card">
                        <div className="course-header">
                          <h3>{course.name}</h3>
                          <span className="course-category">{course.category}</span>
                        </div>
                        <select
                          className="course-status-select"
                          value={currentStatus}
                          onChange={(e) => handleCourseStatusChange(
                            localSelectedStudent.id,
                            course.id,
                            e.target.value
                          )}
                          disabled={!canEdit}
                        >
                          <option value="not-started">Not Started</option>
                          <option value="in-progress">In Progress</option>
                          <option value="completed">Completed</option>
                          <option value="passed">Passed</option>
                        </select>
                      </div>
                    );
                  })}
                </div>
              </>
            ) : (
              <div className="empty-state">
                <BookOpen size={48} />
                <p>Select a student to view their course progress</p>
              </div>
            )}
          </div>
        </div>
      </div>
    );
  };

  // Component: Service Rotations
  const ServiceRotationsView = () => {
    const [showRotationModal, setShowRotationModal] = useState(false);
    const [editingRotation, setEditingRotation] = useState(null);
    const [rotationForm, setRotationForm] = useState({
      date: '',
      serviceType: '',
      volunteers: '',
    });

    const serviceTypes = [
      'Altar Service',
      'Ushers',
      'Hymns/Praise',
      'Readings',
      'Offering',
      'Multimedia',
      'Cleaning',
      'Setup/Teardown'
    ];

    const openRotationModal = (rotation = null) => {
      if (!canEdit) return;
      if (rotation) {
        setEditingRotation(rotation);
        setRotationForm({
          date: rotation.date,
          serviceType: rotation.serviceType,
          volunteers: rotation.volunteers,
        });
      } else {
        setEditingRotation(null);
        setRotationForm({ date: '', serviceType: '', volunteers: '' });
      }
      setShowRotationModal(true);
    };

    const closeRotationModal = () => {
      setShowRotationModal(false);
      setEditingRotation(null);
      setRotationForm({ date: '', serviceType: '', volunteers: '' });
    };

    const saveRotation = () => {
      if (!canEdit) return;
      if (!rotationForm.date || !rotationForm.serviceType || !rotationForm.volunteers) {
        alert('Please fill in all fields');
        return;
      }

      if (editingRotation) {
        setServiceRotations(
          serviceRotations.map(r =>
            r.id === editingRotation.id
              ? { ...r, ...rotationForm }
              : r
          )
        );
      } else {
        const newRotation = {
          id: Date.now(),
          ...rotationForm,
        };
        setServiceRotations([...serviceRotations, newRotation]);
      }
      closeRotationModal();
    };

    const deleteRotation = (id) => {
      if (!canDelete) return;
      if (confirm('Are you sure you want to delete this rotation?')) {
        setServiceRotations(serviceRotations.filter(r => r.id !== id));
      }
    };

    const sortedRotations = [...serviceRotations].sort((a, b) => new Date(b.date) - new Date(a.date));

    return (
      <div className="content-section">
        <div className="section-header">
          <h1>Service Rotations</h1>
          {canEdit && (
            <button className="btn-primary" onClick={() => openRotationModal()}>
              <Plus size={18} /> Add Rotation
            </button>
          )}
        </div>

        {!canEdit && <ReadOnlyNotice />}

        <div className="rotation-list">
          {sortedRotations.length === 0 ? (
            <div className="empty-state">
              <Calendar size={48} />
              <p>No service rotations scheduled yet</p>
              {canEdit && (
                <button className="btn-primary" onClick={() => openRotationModal()}>
                  <Plus size={18} /> Schedule First Rotation
                </button>
              )}
            </div>
          ) : (
            sortedRotations.map(rotation => {
              const rotationDate = new Date(rotation.date);
              return (
                <div key={rotation.id} className="rotation-item">
                  <div className="rotation-date">
                    <div className="date-day">{rotationDate.getDate().toString().padStart(2, '0')}</div>
                    <div className="date-month">{rotationDate.toLocaleDateString('en-US', { month: 'short' })}</div>
                  </div>
                  <div className="rotation-details">
                    <h4>{rotation.serviceType}</h4>
                    <p>{rotation.volunteers}</p>
                  </div>
                  <div className="rotation-actions">
                    {canEdit && (
                      <button className="icon-btn" onClick={() => openRotationModal(rotation)}>
                        <Edit2 size={16} />
                      </button>
                    )}
                    {canDelete && (
                      <button className="icon-btn danger" onClick={() => deleteRotation(rotation.id)}>
                        <Trash2 size={16} />
                      </button>
                    )}
                  </div>
                </div>
              );
            })
          )}
        </div>

        {showRotationModal && (
          <div className="modal-overlay" onClick={closeRotationModal}>
            <div className="modal-content" onClick={(e) => e.stopPropagation()}>
              <div className="modal-header">
                <h2>{editingRotation ? 'Edit Rotation' : 'Add Service Rotation'}</h2>
                <button className="close-btn" onClick={closeRotationModal}>
                  <X size={20} />
                </button>
              </div>

              <div className="modal-body">
                <div className="form-group">
                  <label>Date</label>
                  <input
                    type="date"
                    value={rotationForm.date}
                    onChange={(e) => setRotationForm({ ...rotationForm, date: e.target.value })}
                  />
                </div>

                <div className="form-group">
                  <label>Service Type</label>
                  <select
                    value={rotationForm.serviceType}
                    onChange={(e) => setRotationForm({ ...rotationForm, serviceType: e.target.value })}
                  >
                    <option value="">Select service type...</option>
                    {serviceTypes.map(type => (
                      <option key={type} value={type}>{type}</option>
                    ))}
                  </select>
                </div>

                <div className="form-group">
                  <label>Volunteers (comma-separated names)</label>
                  <textarea
                    rows="3"
                    value={rotationForm.volunteers}
                    onChange={(e) => setRotationForm({ ...rotationForm, volunteers: e.target.value })}
                    placeholder="e.g., Elijah Benjamin, Martin Kusto, Alexandra Gerges"
                  />
                </div>
              </div>

              <div className="modal-footer">
                <button className="btn-secondary" onClick={closeRotationModal}>Cancel</button>
                <button className="btn-primary" onClick={saveRotation}>
                  <Save size={18} /> Save Rotation
                </button>
              </div>
            </div>
          </div>
        )}
      </div>
    );
  };

  // Component: Visitations
  const VisitationsView = () => {
    const [showVisitModal, setShowVisitModal] = useState(false);
    const [editingVisit, setEditingVisit] = useState(null);
    const [visitForm, setVisitForm] = useState({
      studentId: '',
      date: '',
      servants: '',
      groupSize: '',
      notes: '',
      completed: false,
    });
    const [filterStatus, setFilterStatus] = useState('all');

    const openVisitModal = (visit = null) => {
      if (!canEdit) return;
      if (visit) {
        setEditingVisit(visit);
        setVisitForm({
          studentId: visit.studentId,
          date: visit.date,
          servants: visit.servants,
          groupSize: visit.groupSize,
          notes: visit.notes || '',
          completed: visit.completed,
        });
      } else {
        setEditingVisit(null);
        setVisitForm({
          studentId: '',
          date: '',
          servants: '',
          groupSize: '',
          notes: '',
          completed: false,
        });
      }
      setShowVisitModal(true);
    };

    const closeVisitModal = () => {
      setShowVisitModal(false);
      setEditingVisit(null);
      setVisitForm({
        studentId: '',
        date: '',
        servants: '',
        groupSize: '',
        notes: '',
        completed: false,
      });
    };

    const saveVisit = () => {
      if (!canEdit) return;
      if (!visitForm.studentId || !visitForm.date || !visitForm.servants) {
        alert('Please fill in required fields (Student, Date, Servants)');
        return;
      }

      if (editingVisit) {
        setVisitations(
          visitations.map(v =>
            v.id === editingVisit.id
              ? { ...v, ...visitForm }
              : v
          )
        );
      } else {
        const newVisit = {
          id: Date.now(),
          ...visitForm,
        };
        setVisitations([...visitations, newVisit]);
      }
      closeVisitModal();
    };

    const deleteVisit = (id) => {
      if (!canDelete) return;
      if (confirm('Are you sure you want to delete this visitation?')) {
        setVisitations(visitations.filter(v => v.id !== id));
      }
    };

    const toggleVisitCompleted = (id) => {
      if (!canEdit) return;
      setVisitations(
        visitations.map(v =>
          v.id === id ? { ...v, completed: !v.completed } : v
        )
      );
    };

    const filteredVisitations = visitations.filter(visit => {
      if (filterStatus === 'all') return true;
      if (filterStatus === 'pending') return !visit.completed;
      if (filterStatus === 'completed') return visit.completed;
      return true;
    });

    return (
      <div className="content-section">
        <div className="section-header">
          <h1>Visitations</h1>
          <div style={{ display: 'flex', gap: '1rem', alignItems: 'center' }}>
            <div className="filter-tabs">
              <button
                className={filterStatus === 'all' ? 'active' : ''}
                onClick={() => setFilterStatus('all')}
              >
                All ({visitations.length})
              </button>
              <button
                className={filterStatus === 'pending' ? 'active' : ''}
                onClick={() => setFilterStatus('pending')}
              >
                Pending ({visitations.filter(v => !v.completed).length})
              </button>
              <button
                className={filterStatus === 'completed' ? 'active' : ''}
                onClick={() => setFilterStatus('completed')}
              >
                Completed ({visitations.filter(v => v.completed).length})
              </button>
            </div>
            {canEdit && (
              <button className="btn-primary" onClick={() => openVisitModal()}>
                <Plus size={18} /> Schedule Visit
              </button>
            )}
          </div>
        </div>

        {!canEdit && <ReadOnlyNotice />}

        <div className="visitations-grid">
          {filteredVisitations.length === 0 ? (
            <div className="empty-state">
              <MapPin size={48} />
              <p>No visitations {filterStatus !== 'all' ? filterStatus : 'scheduled'} yet</p>
              {canEdit && (
                <button className="btn-primary" onClick={() => openVisitModal()}>
                  <Plus size={18} /> Schedule First Visit
                </button>
              )}
            </div>
          ) : (
            filteredVisitations.map(visit => {
              const student = students.find(s => s.id === visit.studentId);
              if (!student) return null;

              return (
                <div key={visit.id} className="visitation-card">
                  <div className="visitation-header">
                    <h3>{student.firstName} {student.lastName}</h3>
                    <span className={`visit-status ${visit.completed ? 'completed' : 'pending'}`}>
                      {visit.completed ? 'Completed' : 'Pending'}
                    </span>
                  </div>
                  <div className="visitation-details">
                    <div className="detail-row">
                      <Calendar size={14} />
                      <span>{new Date(visit.date).toLocaleDateString('en-US', { weekday: 'short', year: 'numeric', month: 'short', day: 'numeric' })}</span>
                    </div>
                    <div className="detail-row">
                      <Users size={14} />
                      <span>{visit.servants}</span>
                    </div>
                    {visit.groupSize && (
                      <div className="detail-row">
                        <UserCheck size={14} />
                        <span>Group of {visit.groupSize}</span>
                      </div>
                    )}
                    {student.address && (
                      <div className="detail-row">
                        <MapPin size={14} />
                        <span>{student.address}, {student.city}</span>
                      </div>
                    )}
                    {visit.notes && (
                      <div className="visit-notes">
                        <p>{visit.notes}</p>
                      </div>
                    )}
                  </div>
                  <div className="visitation-actions">
                    {canEdit && (
                      <button
                        className={`btn-outline ${visit.completed ? 'completed' : ''}`}
                        onClick={() => toggleVisitCompleted(visit.id)}
                      >
                        <CheckSquare size={16} />
                        {visit.completed ? 'Mark Pending' : 'Mark Complete'}
                      </button>
                    )}
                    {canEdit && (
                      <button className="icon-btn" onClick={() => openVisitModal(visit)}>
                        <Edit2 size={16} />
                      </button>
                    )}
                    {canDelete && (
                      <button className="icon-btn danger" onClick={() => deleteVisit(visit.id)}>
                        <Trash2 size={16} />
                      </button>
                    )}
                  </div>
                </div>
              );
            })
          )}
        </div>

        {showVisitModal && (
          <div className="modal-overlay" onClick={closeVisitModal}>
            <div className="modal-content" onClick={(e) => e.stopPropagation()}>
              <div className="modal-header">
                <h2>{editingVisit ? 'Edit Visitation' : 'Schedule Visitation'}</h2>
                <button className="close-btn" onClick={closeVisitModal}>
                  <X size={20} />
                </button>
              </div>

              <div className="modal-body">
                <div className="form-group">
                  <label>Student *</label>
                  <select
                    value={visitForm.studentId}
                    onChange={(e) => setVisitForm({ ...visitForm, studentId: parseInt(e.target.value) })}
                  >
                    <option value="">Select a student...</option>
                    {students.filter(s => s.status === 'Active').map(student => (
                      <option key={student.id} value={student.id}>
                        {student.firstName} {student.lastName} ({student.grade})
                      </option>
                    ))}
                  </select>
                </div>

                <div className="form-group">
                  <label>Visit Date *</label>
                  <input
                    type="date"
                    value={visitForm.date}
                    onChange={(e) => setVisitForm({ ...visitForm, date: e.target.value })}
                  />
                </div>

                <div className="form-group">
                  <label>Servants Assigned *</label>
                  <input
                    type="text"
                    value={visitForm.servants}
                    onChange={(e) => setVisitForm({ ...visitForm, servants: e.target.value })}
                    placeholder="e.g., Mariam, Peter"
                  />
                </div>

                <div className="form-group">
                  <label>Group Size</label>
                  <input
                    type="number"
                    value={visitForm.groupSize}
                    onChange={(e) => setVisitForm({ ...visitForm, groupSize: e.target.value })}
                    placeholder="Number of people in visitation group"
                    min="1"
                  />
                </div>

                <div className="form-group">
                  <label>Notes</label>
                  <textarea
                    rows="3"
                    value={visitForm.notes}
                    onChange={(e) => setVisitForm({ ...visitForm, notes: e.target.value })}
                    placeholder="Additional notes about the visit..."
                  />
                </div>

                <div className="form-group">
                  <label style={{ display: 'flex', alignItems: 'center', gap: '0.5rem', cursor: 'pointer' }}>
                    <input
                      type="checkbox"
                      checked={visitForm.completed}
                      onChange={(e) => setVisitForm({ ...visitForm, completed: e.target.checked })}
                    />
                    Mark as completed
                  </label>
                </div>
              </div>

              <div className="modal-footer">
                <button className="btn-secondary" onClick={closeVisitModal}>Cancel</button>
                <button className="btn-primary" onClick={saveVisit}>
                  <Save size={18} /> Save Visitation
                </button>
              </div>
            </div>
          </div>
        )}
      </div>
    );
  };

  // Component: Student Detail View
  const StudentDetail = () => {
    if (!selectedStudent) return null;

    const studentAttendance = attendance.filter(a => a.studentId === selectedStudent.id);
    const studentCourseProgress = courseProgress.filter(cp => cp.studentId === selectedStudent.id);

    const attendancePercentage = studentAttendance.length > 0
      ? Math.round((studentAttendance.filter(a => a.present).length / studentAttendance.length) * 100)
      : 0;

    return (
      <div className="content-section">
        <div className="section-header">
          <button className="btn-outline" onClick={() => setCurrentView('students')}>
            â† Back to Students
          </button>
          {canEdit && (
            <button className="btn-primary" onClick={() => setShowModal(true)}>
              <Edit2 size={18} /> Edit Student
            </button>
          )}
        </div>

        {!canEdit && <ReadOnlyNotice />}

        <div className="student-detail-container">
          {/* Student Profile Card */}
          <div className="detail-card">
            <div className="detail-header">
              <div className="student-avatar" style={{ width: '80px', height: '80px', fontSize: '2rem' }}>
                {selectedStudent.firstName[0]}{selectedStudent.lastName[0]}
              </div>
              <div>
                <h1>{selectedStudent.firstName} {selectedStudent.lastName}</h1>
                <span className={`status-badge status-${selectedStudent.status?.toLowerCase() || 'active'}`}>
                  {selectedStudent.status || 'Active'}
                </span>
              </div>
            </div>

            <div className="detail-grid">
              <div className="detail-item">
                <label>Grade</label>
                <p>{selectedStudent.grade}</p>
              </div>
              <div className="detail-item">
                <label>Date of Birth</label>
                <p>{selectedStudent.dob || 'Not provided'}</p>
              </div>
              <div className="detail-item">
                <label>Phone</label>
                <p>{selectedStudent.phone || 'Not provided'}</p>
              </div>
              <div className="detail-item">
                <label>Email</label>
                <p>{selectedStudent.email || 'Not provided'}</p>
              </div>
              <div className="detail-item">
                <label>Responsible Servant</label>
                <p>{selectedStudent.responsibleServant || 'Not assigned'}</p>
              </div>
              <div className="detail-item">
                <label>Attendance Rate</label>
                <p style={{ color: attendancePercentage >= 75 ? 'var(--success)' : 'var(--warning)' }}>
                  {attendancePercentage}%
                </p>
              </div>
            </div>
          </div>

          {/* Parent Information */}
          {(selectedStudent.parent1Name || selectedStudent.parent2Name) && (
            <div className="detail-card">
              <h2>Parent Information</h2>
              <div className="parents-grid">
                {selectedStudent.parent1Name && (
                  <div className="parent-card">
                    <h3>Parent 1</h3>
                    <div className="detail-item">
                      <label>Name</label>
                      <p>{selectedStudent.parent1Name}</p>
                    </div>
                    {selectedStudent.parent1Phone && (
                      <div className="detail-item">
                        <label>Phone</label>
                        <p>{selectedStudent.parent1Phone}</p>
                      </div>
                    )}
                    {selectedStudent.parent1Email && (
                      <div className="detail-item">
                        <label>Email</label>
                        <p>{selectedStudent.parent1Email}</p>
                      </div>
                    )}
                  </div>
                )}
                {selectedStudent.parent2Name && (
                  <div className="parent-card">
                    <h3>Parent 2</h3>
                    <div className="detail-item">
                      <label>Name</label>
                      <p>{selectedStudent.parent2Name}</p>
                    </div>
                    {selectedStudent.parent2Phone && (
                      <div className="detail-item">
                        <label>Phone</label>
                        <p>{selectedStudent.parent2Phone}</p>
                      </div>
                    )}
                    {selectedStudent.parent2Email && (
                      <div className="detail-item">
                        <label>Email</label>
                        <p>{selectedStudent.parent2Email}</p>
                      </div>
                    )}
                  </div>
                )}
              </div>
            </div>
          )}

          {/* Address Information */}
          {selectedStudent.address && (
            <div className="detail-card">
              <h2>Address</h2>
              <div className="detail-grid">
                <div className="detail-item">
                  <label>Street Address</label>
                  <p>{selectedStudent.address}</p>
                </div>
                <div className="detail-item">
                  <label>City</label>
                  <p>{selectedStudent.city || 'Not provided'}</p>
                </div>
                <div className="detail-item">
                  <label>Zipcode</label>
                  <p>{selectedStudent.zipcode || 'Not provided'}</p>
                </div>
              </div>
            </div>
          )}

          {/* Attendance History */}
          <div className="detail-card">
            <h2>Attendance History</h2>
            {studentAttendance.length > 0 ? (
              <div className="attendance-history">
                {studentAttendance.slice(-10).reverse().map(record => (
                  <div key={record.id} className="attendance-record">
                    <span className="record-date">{record.date} ({record.day})</span>
                    <span className={`record-status ${record.present ? 'present' : 'absent'}`}>
                      {record.present ? 'âœ“ Present' : 'âœ— Absent'}
                    </span>
                  </div>
                ))}
              </div>
            ) : (
              <p style={{ color: 'var(--text-secondary)' }}>No attendance records yet</p>
            )}
          </div>

          {/* Course Progress */}
          <div className="detail-card">
            <h2>Servants Preparation Progress</h2>
            {studentCourseProgress.length > 0 ? (
              <div className="course-progress-grid">
                {initialCourses.map(course => {
                  const progress = studentCourseProgress.find(cp => cp.courseId === course.id);
                  return (
                    <div key={course.id} className="course-progress-item">
                      <div className="course-name">{course.name}</div>
                      <span className={`course-status-badge status-${progress?.status || 'not-started'}`}>
                        {progress?.status ? progress.status.replace('-', ' ') : 'Not Started'}
                      </span>
                    </div>
                  );
                })}
              </div>
            ) : (
              <p style={{ color: 'var(--text-secondary)' }}>
                No course progress tracked yet. Visit{' '}
                <button
                  onClick={() => setCurrentView('servantsPrep')}
                  style={{ color: 'var(--primary)', textDecoration: 'underline', background: 'none', border: 'none', cursor: 'pointer' }}
                >
                  Servants Prep
                </button>
                {' '}to start tracking.
              </p>
            )}
          </div>
        </div>
      </div>
    );
  };

  // Component: Data Import/Export
  const DataImportView = () => {
    const [importStep, setImportStep] = useState('upload'); // upload, preview, confirm
    const [importType, setImportType] = useState('students');
    const [csvFile, setCsvFile] = useState(null);
    const [parsedData, setParsedData] = useState([]);
    const [importErrors, setImportErrors] = useState([]);

    const handleFileSelect = (e) => {
      const file = e.target.files[0];
      if (file && file.type === 'text/csv') {
        setCsvFile(file);
        parseCSV(file);
      } else {
        alert('Please select a valid CSV file');
      }
    };

    const parseCSV = (file) => {
      Papa.parse(file, {
        header: true,
        skipEmptyLines: true,
        complete: (results) => {
          setParsedData(results.data);
          validateData(results.data);
          setImportStep('preview');
        },
        error: (error) => {
          alert('Error parsing CSV: ' + error.message);
        }
      });
    };

    const validateData = (data) => {
      const errors = [];

      if (importType === 'students') {
        data.forEach((row, index) => {
          if (!row.firstName || !row.lastName) {
            errors.push(`Row ${index + 1}: Missing firstName or lastName`);
          }
          if (!row.grade || !['9th', '10th', '11th', '12th'].includes(row.grade)) {
            errors.push(`Row ${index + 1}: Invalid grade (must be 9th, 10th, 11th, or 12th)`);
          }
        });
      }

      setImportErrors(errors);
    };

    const executeImport = () => {
      if (importErrors.length > 0) {
        if (!confirm('There are validation errors. Continue anyway?')) {
          return;
        }
      }

      if (importType === 'students') {
        const newStudents = parsedData.map((row, index) => ({
          id: Date.now() + index,
          firstName: row.firstName || '',
          lastName: row.lastName || '',
          grade: row.grade || '9th',
          phone: row.phone || '',
          email: row.email || '',
          dob: row.dob || '',
          responsibleServant: row.responsibleServant || '',
          status: row.status || 'Active',
          parent1Name: row.parent1Name || '',
          parent1Phone: row.parent1Phone || '',
          parent1Email: row.parent1Email || '',
          parent2Name: row.parent2Name || '',
          parent2Phone: row.parent2Phone || '',
          parent2Email: row.parent2Email || '',
          address: row.address || '',
          city: row.city || '',
          zipcode: row.zipcode || '',
        }));

        setStudents([...students, ...newStudents]);
        alert(`Successfully imported ${newStudents.length} students!`);
      }

      resetImport();
      setCurrentView('students');
    };

    const resetImport = () => {
      setImportStep('upload');
      setCsvFile(null);
      setParsedData([]);
      setImportErrors([]);
    };

    const exportData = (dataType) => {
      let data, filename;

      if (dataType === 'students') {
        data = students;
        filename = 'students_export.csv';
      } else if (dataType === 'attendance') {
        const attendanceExport = attendance.map(a => {
          const student = students.find(s => s.id === a.studentId);
          return {
            date: a.date,
            day: a.day,
            studentName: student ? `${student.firstName} ${student.lastName}` : 'Unknown',
            present: a.present ? 'Yes' : 'No'
          };
        });
        data = attendanceExport;
        filename = 'attendance_export.csv';
      } else if (dataType === 'courseProgress') {
        const progressExport = courseProgress.map(cp => {
          const student = students.find(s => s.id === cp.studentId);
          const course = initialCourses.find(c => c.id === cp.courseId);
          return {
            studentName: student ? `${student.firstName} ${student.lastName}` : 'Unknown',
            courseName: course ? course.name : 'Unknown',
            status: cp.status
          };
        });
        data = progressExport;
        filename = 'course_progress_export.csv';
      } else if (dataType === 'all') {
        const allData = {
          students,
          attendance,
          courseProgress,
          serviceRotations,
          visitations
        };
        const blob = new Blob([JSON.stringify(allData, null, 2)], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const link = document.createElement('a');
        link.href = url;
        link.download = 'all_data_backup.json';
        link.click();
        URL.revokeObjectURL(url);
        return;
      }

      const csv = Papa.unparse(data);
      const blob = new Blob([csv], { type: 'text/csv' });
      const url = URL.createObjectURL(blob);
      const link = document.createElement('a');
      link.href = url;
      link.download = filename;
      link.click();
      URL.revokeObjectURL(url);
    };

    return (
      <div className="content-section">
        <div className="section-header">
          <h1>Data Import & Export</h1>
        </div>

        {!canImport && <ReadOnlyNotice message="Read-only access: imports are disabled for your role." />}

        <div className="import-export-container">
          {/* Export Section */}
          <div className="import-export-card">
            <div className="card-icon">
              <FileDown size={32} />
            </div>
            <h2>Export Data</h2>
            <p>Download your data as CSV or JSON backup</p>
            <div className="export-buttons">
              <button className="btn-outline" onClick={() => exportData('students')}>
                <Download size={16} />
                Export Students (CSV)
              </button>
              <button className="btn-outline" onClick={() => exportData('attendance')}>
                <Download size={16} />
                Export Attendance (CSV)
              </button>
              <button className="btn-outline" onClick={() => exportData('courseProgress')}>
                <Download size={16} />
                Export Course Progress (CSV)
              </button>
              <button className="btn-primary" onClick={() => exportData('all')}>
                <Download size={16} />
                Full Backup (JSON)
              </button>
            </div>
          </div>

          {/* Import Section */}
          {canImport ? (
            <div className="import-export-card">
              <div className="card-icon">
                <FileUp size={32} />
              </div>
              <h2>Import Data</h2>
              <p>Upload CSV files to import student data</p>

              {importStep === 'upload' && (
                <div className="import-upload">
                  <div className="form-group">
                    <label>Import Type</label>
                    <select value={importType} onChange={(e) => setImportType(e.target.value)}>
                      <option value="students">Students</option>
                    </select>
                  </div>

                  <div className="file-upload-area">
                    <input
                      type="file"
                      accept=".csv"
                      onChange={handleFileSelect}
                      id="csv-upload"
                      style={{ display: 'none' }}
                    />
                    <label htmlFor="csv-upload" className="file-upload-label">
                      <Upload size={48} />
                      <p>Click to select CSV file</p>
                      <span>or drag and drop</span>
                    </label>
                  </div>

                  <div className="import-help">
                    <AlertCircle size={16} />
                    <div>
                      <strong>CSV Format Requirements:</strong>
                      <ul>
                        <li>Required: firstName, lastName, grade</li>
                        <li>Optional: phone, email, dob, responsibleServant, status, parent info, address</li>
                        <li>Grade must be: 9th, 10th, 11th, or 12th</li>
                      </ul>
                    </div>
                  </div>
                </div>
              )}

              {importStep === 'preview' && (
                <div className="import-preview">
                  <h3>Import Preview</h3>
                  <p>Found {parsedData.length} records</p>

                  {importErrors.length > 0 && (
                    <div className="import-errors">
                      <AlertCircle size={16} />
                      <div>
                        <strong>{importErrors.length} validation errors:</strong>
                        <ul>
                          {importErrors.slice(0, 5).map((error, i) => (
                            <li key={i}>{error}</li>
                          ))}
                          {importErrors.length > 5 && <li>...and {importErrors.length - 5} more</li>}
                        </ul>
                      </div>
                    </div>
                  )}

                  <div className="preview-table">
                    <table>
                      <thead>
                        <tr>
                          <th>First Name</th>
                          <th>Last Name</th>
                          <th>Grade</th>
                          <th>Phone</th>
                          <th>Status</th>
                        </tr>
                      </thead>
                      <tbody>
                        {parsedData.slice(0, 10).map((row, i) => (
                          <tr key={i}>
                            <td>{row.firstName}</td>
                            <td>{row.lastName}</td>
                            <td>{row.grade}</td>
                            <td>{row.phone}</td>
                            <td>{row.status || 'Active'}</td>
                          </tr>
                        ))}
                      </tbody>
                    </table>
                    {parsedData.length > 10 && (
                      <p style={{ marginTop: '1rem', textAlign: 'center', color: 'var(--text-secondary)' }}>
                        Showing 10 of {parsedData.length} records
                      </p>
                    )}
                  </div>

                  <div className="import-actions">
                    <button className="btn-secondary" onClick={resetImport}>Cancel</button>
                    <button className="btn-primary" onClick={executeImport}>
                      <Upload size={16} />
                      Import {parsedData.length} Students
                    </button>
                  </div>
                </div>
              )}
            </div>
          ) : (
            <div className="import-export-card">
              <div className="card-icon">
                <FileUp size={32} />
              </div>
              <h2>Import Data</h2>
              <p>Imports are disabled for your role.</p>
            </div>
          )}
        </div>
      </div>
    );
  };

  // Component: User Management (Admin only)
  const UserManagementView = () => {
    const [users, setUsers] = useState(() => readUsers());
    const [showUserModal, setShowUserModal] = useState(false);
    const [editingUser, setEditingUser] = useState(null);
    const [modalMode, setModalMode] = useState('create');
    const [formData, setFormData] = useState({
      fullName: '',
      username: '',
      email: '',
      role: 'servant',
      password: '',
      confirmPassword: '',
      isActive: true
    });
    const [formError, setFormError] = useState('');

    useEffect(() => {
      setUsers(readUsers());
    }, []);

    const openUserModal = (user = null, mode = 'edit') => {
      setFormError('');
      setModalMode(mode);
      if (user) {
        setEditingUser(user);
        setFormData({
          fullName: user.fullName || '',
          username: user.username || '',
          email: user.email || '',
          role: user.role || 'servant',
          password: '',
          confirmPassword: '',
          isActive: Boolean(user.isActive)
        });
      } else {
        setEditingUser(null);
        setFormData({
          fullName: '',
          username: '',
          email: '',
          role: 'servant',
          password: '',
          confirmPassword: '',
          isActive: true
        });
      }
      setShowUserModal(true);
    };

    const closeUserModal = () => {
      setShowUserModal(false);
      setEditingUser(null);
      setModalMode('create');
      setFormError('');
    };

    const handleSaveUser = async () => {
      setFormError('');
      if (modalMode === 'reset') {
        if (!formData.password || !formData.confirmPassword) {
          setFormError('Password and confirmation are required.');
          return;
        }
        if (formData.password.length < 8 || !/[0-9]/.test(formData.password) || !/[A-Za-z]/.test(formData.password)) {
          setFormError('Password must be at least 8 characters and include letters and numbers.');
          return;
        }
        if (formData.password !== formData.confirmPassword) {
          setFormError('Passwords do not match.');
          return;
        }

        const passwordHash = await hashPassword(formData.password);
        const nextUsers = users.map((user) => {
          if (user.id !== editingUser?.id) return user;
          return {
            ...user,
            passwordHash,
            updatedAt: nowIso(),
            failedAttempts: 0,
            lockedUntil: null
          };
        });

        writeUsers(nextUsers);
        setUsers(nextUsers);
        logAudit('Password Reset', `Password reset for ${editingUser?.username}.`);
        closeUserModal();
        return;
      }

      if (!formData.fullName.trim() || !formData.username.trim()) {
        setFormError('Full name and username are required.');
        return;
      }

      const normalized = normalizeUsername(formData.username);
      const existingIndex = users.findIndex((user) => user.username === normalized);
      if (existingIndex !== -1 && (!editingUser || users[existingIndex].id !== editingUser.id)) {
        setFormError('That username is already in use.');
        return;
      }

      if (!editingUser && (!formData.password || !formData.confirmPassword)) {
        setFormError('Password and confirmation are required for new users.');
        return;
      }

      if (formData.password || formData.confirmPassword) {
        if (formData.password.length < 8 || !/[0-9]/.test(formData.password) || !/[A-Za-z]/.test(formData.password)) {
          setFormError('Password must be at least 8 characters and include letters and numbers.');
          return;
        }
        if (formData.password !== formData.confirmPassword) {
          setFormError('Passwords do not match.');
          return;
        }
      }

      const nextUsers = [...users];
      if (editingUser) {
        if (editingUser.id === currentUser?.id && !formData.isActive) {
          setFormError('You cannot deactivate your own account.');
          return;
        }
        const updatedUser = {
          ...editingUser,
          fullName: formData.fullName.trim(),
          username: normalized,
          email: formData.email.trim(),
          role: formData.role,
          isActive: formData.isActive,
          updatedAt: nowIso()
        };
        if (formData.password) {
          updatedUser.passwordHash = await hashPassword(formData.password);
        }
        nextUsers[existingIndex] = updatedUser;
        writeUsers(nextUsers);
        setUsers(nextUsers);
        logAudit('User Updated', `Updated user ${updatedUser.username}.`);
      } else {
        const passwordHash = await hashPassword(formData.password);
        const newUser = {
          id: Date.now(),
          username: normalized,
          passwordHash,
          fullName: formData.fullName.trim(),
          email: formData.email.trim(),
          role: formData.role,
          isActive: formData.isActive,
          createdAt: nowIso(),
          updatedAt: nowIso(),
          failedAttempts: 0,
          lockedUntil: null
        };
        const updatedUsers = [...users, newUser];
        writeUsers(updatedUsers);
        setUsers(updatedUsers);
        logAudit('User Created', `Created user ${newUser.username} (${newUser.role}).`);
      }
      closeUserModal();
    };

    const toggleUserActive = (user) => {
      if (user.id === currentUser?.id) return;
      const nextUsers = users.map((item) =>
        item.id === user.id
          ? { ...item, isActive: !item.isActive, updatedAt: nowIso() }
          : item
      );
      writeUsers(nextUsers);
      setUsers(nextUsers);
      logAudit('User Status', `User ${user.username} set to ${user.isActive ? 'inactive' : 'active'}.`);
    };

    const isLocked = (user) => user.lockedUntil && new Date(user.lockedUntil).getTime() > Date.now();

    const unlockUser = (user) => {
      const nextUsers = users.map((item) => (
        item.id === user.id
          ? { ...item, failedAttempts: 0, lockedUntil: null, updatedAt: nowIso() }
          : item
      ));
      writeUsers(nextUsers);
      setUsers(nextUsers);
      logAudit('User Unlock', `User ${user.username} unlocked.`);
    };

    if (!canManageUsers) {
      return (
        <div className="content-section">
          <div className="section-header">
            <h1>User Management</h1>
          </div>
          <p style={{ color: 'var(--text-secondary)' }}>You do not have access to manage users.</p>
        </div>
      );
    }

    return (
      <div className="content-section">
        <div className="section-header">
          <h1>User Management</h1>
          <button className="btn-primary" onClick={() => openUserModal(null, 'create')}>
            <Plus size={18} /> Add User
          </button>
        </div>

        <div className="users-table">
          <div className="users-table-header">
            <span>Name</span>
            <span>Username</span>
            <span>Role</span>
            <span>Status</span>
            <span>Actions</span>
          </div>
          {users.map((user) => {
            const locked = isLocked(user);
            return (
            <div key={user.id} className="users-table-row">
              <div className="user-cell">
                <div className="user-avatar-sm">{toInitials(user.fullName || user.username)}</div>
                <div>
                  <div className="user-name">{user.fullName || user.username}</div>
                  <div className="user-email">{user.email || 'No email'}</div>
                  {locked && (
                    <div className="user-lockout">
                      Locked until {new Date(user.lockedUntil).toLocaleString()}
                    </div>
                  )}
                </div>
              </div>
              <span>{user.username}</span>
              <span className={`role-badge role-${user.role}`}>{user.role}</span>
              <div className="status-stack">
                <span className={`status-badge ${user.isActive ? 'status-active' : 'status-transferred'}`}>
                  {user.isActive ? 'Active' : 'Inactive'}
                </span>
                {locked && <span className="status-badge status-locked">Locked</span>}
              </div>
              <div className="user-actions">
                <button className="icon-btn" onClick={() => openUserModal(user, 'edit')}>
                  <Edit2 size={16} />
                </button>
                <button className="icon-btn" onClick={() => openUserModal(user, 'reset')}>
                  <KeyRound size={16} />
                </button>
                <button
                  className="icon-btn"
                  onClick={() => toggleUserActive(user)}
                  disabled={user.id === currentUser?.id}
                >
                  {user.isActive ? <EyeOff size={16} /> : <Eye size={16} />}
                </button>
                {locked && (
                  <button className="icon-btn" onClick={() => unlockUser(user)}>
                    <AlertCircle size={16} />
                  </button>
                )}
              </div>
            </div>
          );
          })}
        </div>

        {showUserModal && (
          <div className="modal-overlay" onClick={closeUserModal}>
            <div className="modal-content" onClick={(e) => e.stopPropagation()}>
              <div className="modal-header">
                <h2>
                  {modalMode === 'create' && 'Add User'}
                  {modalMode === 'edit' && 'Edit User'}
                  {modalMode === 'reset' && 'Reset Password'}
                </h2>
                <button className="icon-btn" onClick={closeUserModal}>
                  <X size={20} />
                </button>
              </div>

              <form className="user-form" onSubmit={(e) => { e.preventDefault(); handleSaveUser(); }}>
                {modalMode !== 'reset' && (
                  <>
                    <div className="form-group">
                      <label>Full Name *</label>
                      <input
                        type="text"
                        value={formData.fullName}
                        onChange={(e) => setFormData({ ...formData, fullName: e.target.value })}
                        required
                      />
                    </div>

                    <div className="form-row">
                      <div className="form-group">
                        <label>Username *</label>
                        <input
                          type="text"
                          value={formData.username}
                          onChange={(e) => setFormData({ ...formData, username: e.target.value })}
                          required
                        />
                      </div>
                      <div className="form-group">
                        <label>Email</label>
                        <input
                          type="email"
                          value={formData.email}
                          onChange={(e) => setFormData({ ...formData, email: e.target.value })}
                        />
                      </div>
                    </div>

                    <div className="form-row">
                      <div className="form-group">
                        <label>Role</label>
                        <select
                          value={formData.role}
                          onChange={(e) => setFormData({ ...formData, role: e.target.value })}
                        >
                          <option value="admin">Admin</option>
                          <option value="servant">Servant</option>
                          <option value="viewer">Viewer</option>
                        </select>
                      </div>
                      <div className="form-group">
                        <label>Status</label>
                        <select
                          value={formData.isActive ? 'active' : 'inactive'}
                          onChange={(e) => setFormData({ ...formData, isActive: e.target.value === 'active' })}
                          disabled={editingUser?.id === currentUser?.id}
                        >
                          <option value="active">Active</option>
                          <option value="inactive">Inactive</option>
                        </select>
                      </div>
                    </div>
                  </>
                )}

                <div className="form-row">
                  <div className="form-group">
                    <label>{editingUser ? 'New Password' : 'Password *'}</label>
                    <input
                      type="password"
                      value={formData.password}
                      onChange={(e) => setFormData({ ...formData, password: e.target.value })}
                      required={!editingUser || modalMode === 'reset'}
                    />
                  </div>
                  <div className="form-group">
                    <label>{editingUser ? 'Confirm New Password' : 'Confirm Password *'}</label>
                    <input
                      type="password"
                      value={formData.confirmPassword}
                      onChange={(e) => setFormData({ ...formData, confirmPassword: e.target.value })}
                      required={!editingUser || modalMode === 'reset'}
                    />
                  </div>
                </div>

                {formError && <div className="auth-error">{formError}</div>}

                <div className="modal-actions">
                  <button type="button" className="btn-outline" onClick={closeUserModal}>
                    Cancel
                  </button>
                  <button type="submit" className="btn-primary">
                    <Save size={18} />
                    {modalMode === 'reset' ? 'Reset Password' : (editingUser ? 'Update User' : 'Create User')}
                  </button>
                </div>
              </form>
            </div>
          </div>
        )}
      </div>
    );
  };

  // Component: Audit Log (Admin only)
  const AuditLogView = () => {
    const [entries, setEntries] = useState(() => readAudit());

    useEffect(() => {
      if (currentView === 'audit') {
        setEntries(readAudit());
      }
    }, [currentView]);

    if (!canManageUsers) {
      return (
        <div className="content-section">
          <div className="section-header">
            <h1>Audit Log</h1>
          </div>
          <p style={{ color: 'var(--text-secondary)' }}>You do not have access to view the audit log.</p>
        </div>
      );
    }

    return (
      <div className="content-section">
        <div className="section-header">
          <h1>Audit Log</h1>
          <button className="btn-outline" onClick={() => setEntries(readAudit())}>
            Refresh
          </button>
        </div>

        {entries.length === 0 ? (
          <div className="empty-state">
            <Clock size={48} />
            <p>No audit activity recorded yet</p>
          </div>
        ) : (
          <div className="audit-list">
            {entries.slice(0, 200).map((entry) => (
              <div key={entry.id} className="audit-item">
                <div className="audit-meta">
                  <span className="audit-action">{entry.action}</span>
                  <span className="audit-time">
                    {new Date(entry.timestamp).toLocaleString()}
                  </span>
                </div>
                <div className="audit-detail">{entry.detail}</div>
                <div className="audit-actor">By {entry.actorName || 'System'}</div>
              </div>
            ))}
          </div>
        )}
      </div>
    );
  };

  // Component: Student Modal
  const StudentModal = () => {
    const [formData, setFormData] = useState(selectedStudent || {
      firstName: '',
      lastName: '',
      grade: '9th',
      phone: '',
      email: '',
      dob: '',
      responsibleServant: '',
      status: 'Active',
      parent1Name: '',
      parent1Phone: '',
      parent1Email: '',
      parent2Name: '',
      parent2Phone: '',
      parent2Email: '',
      address: '',
      city: '',
      zipcode: ''
    });

    const handleSubmit = (e) => {
      e.preventDefault();
      if (selectedStudent) {
        updateStudent(selectedStudent.id, formData);
      } else {
        addStudent(formData);
      }
    };

    return (
      <div className="modal-overlay" onClick={() => setShowModal(false)}>
        <div className="modal-content" onClick={(e) => e.stopPropagation()}>
          <div className="modal-header">
            <h2>{selectedStudent ? 'Edit Student' : 'Add New Student'}</h2>
            <button className="icon-btn" onClick={() => setShowModal(false)}>
              <X size={20} />
            </button>
          </div>
          
          <form onSubmit={handleSubmit} className="student-form">
            <div className="form-row">
              <div className="form-group">
                <label>First Name *</label>
                <input
                  type="text"
                  value={formData.firstName}
                  onChange={(e) => setFormData({...formData, firstName: e.target.value})}
                  required
                />
              </div>
              <div className="form-group">
                <label>Last Name *</label>
                <input
                  type="text"
                  value={formData.lastName}
                  onChange={(e) => setFormData({...formData, lastName: e.target.value})}
                  required
                />
              </div>
            </div>

            <div className="form-row">
              <div className="form-group">
                <label>Grade *</label>
                <select
                  value={formData.grade}
                  onChange={(e) => setFormData({...formData, grade: e.target.value})}
                  required
                >
                  <option value="9th">9th Grade</option>
                  <option value="10th">10th Grade</option>
                  <option value="11th">11th Grade</option>
                  <option value="12th">12th Grade</option>
                </select>
              </div>
              <div className="form-group">
                <label>Date of Birth</label>
                <input
                  type="date"
                  value={formData.dob}
                  onChange={(e) => setFormData({...formData, dob: e.target.value})}
                />
              </div>
            </div>

            <div className="form-row">
              <div className="form-group">
                <label>Phone</label>
                <input
                  type="tel"
                  value={formData.phone}
                  onChange={(e) => setFormData({...formData, phone: e.target.value})}
                />
              </div>
              <div className="form-group">
                <label>Email</label>
                <input
                  type="email"
                  value={formData.email}
                  onChange={(e) => setFormData({...formData, email: e.target.value})}
                />
              </div>
            </div>

            <div className="form-row">
              <div className="form-group">
                <label>Responsible Servant</label>
                <select
                  value={formData.responsibleServant}
                  onChange={(e) => setFormData({...formData, responsibleServant: e.target.value})}
                >
                  <option value="">Select Servant</option>
                  <option value="Veronia">Veronia</option>
                  <option value="Magda">Magda</option>
                  <option value="Kero">Kero Basely</option>
                  <option value="Nancy">Nancy</option>
                  <option value="Gerges">Gerges</option>
                  <option value="Mariam">Mariam</option>
                </select>
              </div>
              <div className="form-group">
                <label>Status</label>
                <select
                  value={formData.status}
                  onChange={(e) => setFormData({...formData, status: e.target.value})}
                >
                  <option value="Active">Active</option>
                  <option value="Graduate">Graduate</option>
                  <option value="Transferred">Transferred</option>
                </select>
              </div>
            </div>

            <h3 style={{ marginTop: '1.5rem', marginBottom: '1rem', fontSize: '1.1rem', color: 'var(--primary)' }}>Parent 1 Information</h3>

            <div className="form-row">
              <div className="form-group">
                <label>Parent 1 Name</label>
                <input
                  type="text"
                  value={formData.parent1Name}
                  onChange={(e) => setFormData({...formData, parent1Name: e.target.value})}
                />
              </div>
              <div className="form-group">
                <label>Parent 1 Phone</label>
                <input
                  type="tel"
                  value={formData.parent1Phone}
                  onChange={(e) => setFormData({...formData, parent1Phone: e.target.value})}
                />
              </div>
            </div>

            <div className="form-group">
              <label>Parent 1 Email</label>
              <input
                type="email"
                value={formData.parent1Email}
                onChange={(e) => setFormData({...formData, parent1Email: e.target.value})}
              />
            </div>

            <h3 style={{ marginTop: '1.5rem', marginBottom: '1rem', fontSize: '1.1rem', color: 'var(--primary)' }}>Parent 2 Information</h3>

            <div className="form-row">
              <div className="form-group">
                <label>Parent 2 Name</label>
                <input
                  type="text"
                  value={formData.parent2Name}
                  onChange={(e) => setFormData({...formData, parent2Name: e.target.value})}
                />
              </div>
              <div className="form-group">
                <label>Parent 2 Phone</label>
                <input
                  type="tel"
                  value={formData.parent2Phone}
                  onChange={(e) => setFormData({...formData, parent2Phone: e.target.value})}
                />
              </div>
            </div>

            <div className="form-group">
              <label>Parent 2 Email</label>
              <input
                type="email"
                value={formData.parent2Email}
                onChange={(e) => setFormData({...formData, parent2Email: e.target.value})}
              />
            </div>

            <h3 style={{ marginTop: '1.5rem', marginBottom: '1rem', fontSize: '1.1rem', color: 'var(--primary)' }}>Address Information</h3>

            <div className="form-group">
              <label>Address</label>
              <input
                type="text"
                value={formData.address}
                onChange={(e) => setFormData({...formData, address: e.target.value})}
              />
            </div>

            <div className="form-row">
              <div className="form-group">
                <label>City</label>
                <input
                  type="text"
                  value={formData.city}
                  onChange={(e) => setFormData({...formData, city: e.target.value})}
                />
              </div>
              <div className="form-group">
                <label>Zipcode</label>
                <input
                  type="text"
                  value={formData.zipcode}
                  onChange={(e) => setFormData({...formData, zipcode: e.target.value})}
                />
              </div>
            </div>

            <div className="modal-actions">
              <button type="button" className="btn-outline" onClick={() => setShowModal(false)}>
                Cancel
              </button>
              <button type="submit" className="btn-primary">
                <Save size={18} />
                {selectedStudent ? 'Update' : 'Create'} Student
              </button>
            </div>
          </form>
        </div>
      </div>
    );
  };

  const ReadOnlyNotice = ({ message = 'Read-only access: changes are disabled for your role.' }) => (
    <div className="read-only-banner">
      <AlertCircle size={16} />
      <span>{message}</span>
    </div>
  );

  const SetupWizard = () => {
    const [formData, setFormData] = useState({
      fullName: '',
      username: '',
      email: '',
      password: '',
      confirmPassword: ''
    });
    const [agree, setAgree] = useState(false);
    const [showPassword, setShowPassword] = useState(false);
    const [showConfirm, setShowConfirm] = useState(false);

    const handleSubmit = (event) => {
      event.preventDefault();
      if (!agree) {
        setAuthError('Please agree to the terms of use to continue.');
        return;
      }
      handleSetup(formData);
    };

    return (
      <div className="auth-shell">
        <div className="auth-card">
          <div className="auth-header">
            <div className="auth-logo">YM</div>
            <div>
              <h1>Welcome to Youth Ministry</h1>
              <p>Set up your admin account to begin.</p>
            </div>
          </div>

          <form className="auth-form" onSubmit={handleSubmit}>
            <div className="form-group">
              <label>Full Name</label>
              <input
                type="text"
                value={formData.fullName}
                onChange={(e) => { setAuthError(''); setFormData({ ...formData, fullName: e.target.value }); }}
                required
              />
            </div>

            <div className="form-row">
              <div className="form-group">
                <label>Username</label>
                <input
                  type="text"
                  value={formData.username}
                  onChange={(e) => { setAuthError(''); setFormData({ ...formData, username: e.target.value }); }}
                  required
                />
              </div>
              <div className="form-group">
                <label>Email</label>
                <input
                  type="email"
                  value={formData.email}
                  onChange={(e) => { setAuthError(''); setFormData({ ...formData, email: e.target.value }); }}
                />
              </div>
            </div>

            <div className="form-row">
              <div className="form-group auth-password">
                <label>Password</label>
                <input
                  type={showPassword ? 'text' : 'password'}
                  value={formData.password}
                  onChange={(e) => { setAuthError(''); setFormData({ ...formData, password: e.target.value }); }}
                  required
                />
                <button
                  type="button"
                  className="password-toggle"
                  onClick={() => setShowPassword((value) => !value)}
                >
                  {showPassword ? <EyeOff size={16} /> : <Eye size={16} />}
                </button>
              </div>
              <div className="form-group auth-password">
                <label>Confirm</label>
                <input
                  type={showConfirm ? 'text' : 'password'}
                  value={formData.confirmPassword}
                  onChange={(e) => { setAuthError(''); setFormData({ ...formData, confirmPassword: e.target.value }); }}
                  required
                />
                <button
                  type="button"
                  className="password-toggle"
                  onClick={() => setShowConfirm((value) => !value)}
                >
                  {showConfirm ? <EyeOff size={16} /> : <Eye size={16} />}
                </button>
              </div>
            </div>

            <label className="auth-checkbox">
              <input
                type="checkbox"
                checked={agree}
                onChange={(e) => setAgree(e.target.checked)}
              />
              I agree to the terms of use.
            </label>

            {authError && <div className="auth-error">{authError}</div>}

            <button type="submit" className="btn-primary auth-submit" disabled={authBusy}>
              {authBusy ? 'Setting up...' : 'Continue Setup'}
            </button>
          </form>
        </div>
      </div>
    );
  };

  const LoginScreen = () => {
    const [credentials, setCredentials] = useState({ username: '', password: '', remember: false });
    const [showPassword, setShowPassword] = useState(false);

    const handleSubmit = (event) => {
      event.preventDefault();
      handleLogin(credentials);
    };

    return (
      <div className="auth-shell">
        <div className="auth-card">
          <div className="auth-header">
            <div className="auth-logo">YM</div>
            <div>
              <h1>Youth Ministry System</h1>
              <p>HS 2025-2026</p>
            </div>
          </div>

          <form className="auth-form" onSubmit={handleSubmit}>
            <div className="form-group">
              <label>Username</label>
              <input
                type="text"
                value={credentials.username}
                onChange={(e) => { setAuthError(''); setCredentials({ ...credentials, username: e.target.value }); }}
                required
              />
            </div>

            <div className="form-group auth-password">
              <label>Password</label>
              <input
                type={showPassword ? 'text' : 'password'}
                value={credentials.password}
                onChange={(e) => { setAuthError(''); setCredentials({ ...credentials, password: e.target.value }); }}
                required
              />
              <button
                type="button"
                className="password-toggle"
                onClick={() => setShowPassword((value) => !value)}
              >
                {showPassword ? <EyeOff size={16} /> : <Eye size={16} />}
              </button>
            </div>

            <label className="auth-checkbox">
              <input
                type="checkbox"
                checked={credentials.remember}
                onChange={(e) => setCredentials({ ...credentials, remember: e.target.checked })}
              />
              Remember me
            </label>

            {authError && <div className="auth-error">{authError}</div>}

            <button type="submit" className="btn-primary auth-submit" disabled={authBusy}>
              {authBusy ? 'Signing in...' : 'Login'}
            </button>
          </form>

          <div className="auth-footer">
            <span>Forgot password? Contact an admin.</span>
          </div>
        </div>
      </div>
    );
  };

  // Main render
  if (authMode === 'loading') {
    return (
      <div className="auth-shell">
        <div className="auth-card auth-loading">
          <div className="spinner" />
          <p>Loading...</p>
        </div>
      </div>
    );
  }

  if (authMode === 'setup') {
    return <SetupWizard />;
  }

  if (authMode === 'login') {
    return <LoginScreen />;
  }

  return (
    <div className="app-container">
      <aside className="sidebar">
        <div className="sidebar-header">
          <div className="logo">
            <div className="logo-icon">âœ</div>
            <div className="logo-text">
              <div className="logo-title">Youth Ministry</div>
              <div className="logo-subtitle">HS 2025-2026</div>
            </div>
          </div>
          {currentUser && (
            <div className="sidebar-user">
              <div className="user-avatar">{toInitials(currentUser.fullName || currentUser.username)}</div>
              <div>
                <div className="sidebar-user-name">{currentUser.fullName || currentUser.username}</div>
                <div className="sidebar-user-role">{currentUser.role}</div>
              </div>
            </div>
          )}
        </div>

        <nav className="sidebar-nav">
          <button
            className={`nav-item ${currentView === 'dashboard' ? 'active' : ''}`}
            onClick={() => setCurrentView('dashboard')}
          >
            <Home size={20} />
            <span>Dashboard</span>
          </button>
          
          <button
            className={`nav-item ${currentView === 'students' ? 'active' : ''}`}
            onClick={() => setCurrentView('students')}
          >
            <Users size={20} />
            <span>Students</span>
          </button>
          
          <button
            className={`nav-item ${currentView === 'attendance' ? 'active' : ''}`}
            onClick={() => setCurrentView('attendance')}
          >
            <CheckSquare size={20} />
            <span>Attendance</span>
          </button>
          
          <button
            className={`nav-item ${currentView === 'servantsPrep' ? 'active' : ''}`}
            onClick={() => setCurrentView('servantsPrep')}
          >
            <BookOpen size={20} />
            <span>Servants Prep</span>
          </button>
          
          <button
            className={`nav-item ${currentView === 'rotations' ? 'active' : ''}`}
            onClick={() => setCurrentView('rotations')}
          >
            <Calendar size={20} />
            <span>Service Rotations</span>
          </button>
          
          <button
            className={`nav-item ${currentView === 'visitations' ? 'active' : ''}`}
            onClick={() => setCurrentView('visitations')}
          >
            <MapPin size={20} />
            <span>Visitations</span>
          </button>

          {canManageUsers && (
            <button
              className={`nav-item ${currentView === 'users' ? 'active' : ''}`}
              onClick={() => setCurrentView('users')}
            >
              <UserCheck size={20} />
              <span>User Management</span>
            </button>
          )}

          {canManageUsers && (
            <button
              className={`nav-item ${currentView === 'audit' ? 'active' : ''}`}
              onClick={() => setCurrentView('audit')}
            >
              <Activity size={20} />
              <span>Audit Log</span>
            </button>
          )}

          <button
            className={`nav-item ${currentView === 'import' ? 'active' : ''}`}
            onClick={() => setCurrentView('import')}
          >
            <Upload size={20} />
            <span>Import/Export</span>
          </button>
        </nav>

        <div className="sidebar-footer">
          <button className="nav-item">
            <Settings size={20} />
            <span>Settings</span>
          </button>
          <button className="nav-item" onClick={handleLogout}>
            <LogOut size={20} />
            <span>Logout</span>
          </button>
        </div>
      </aside>

      <main className="main-content">
        <header className="top-header">
          <div className="header-left">
            <h1 className="page-title">
              {currentView === 'dashboard' && 'Dashboard'}
              {currentView === 'students' && 'Students'}
              {currentView === 'attendance' && 'Attendance'}
              {currentView === 'servantsPrep' && 'Servants Preparation'}
              {currentView === 'rotations' && 'Service Rotations'}
              {currentView === 'visitations' && 'Visitations'}
              {currentView === 'users' && 'User Management'}
              {currentView === 'audit' && 'Audit Log'}
            </h1>
          </div>
          <div className="header-right">
            <button className="icon-btn">
              <Bell size={20} />
            </button>
            <div className="user-menu">
              <div className="user-avatar">{toInitials(currentUser?.fullName || currentUser?.username)}</div>
            </div>
          </div>
        </header>

        <div className="content-wrapper">
          {currentView === 'dashboard' && <Dashboard />}
          {currentView === 'students' && <StudentsView />}
          {currentView === 'studentDetail' && <StudentDetail />}
          {currentView === 'attendance' && <AttendanceView />}
          {currentView === 'servantsPrep' && <ServantsPrep />}
          {currentView === 'rotations' && <ServiceRotationsView />}
          {currentView === 'visitations' && <VisitationsView />}
          {currentView === 'users' && <UserManagementView />}
          {currentView === 'audit' && <AuditLogView />}
          {currentView === 'import' && <DataImportView />}
        </div>
      </main>

      {showModal && <StudentModal />}
    </div>
  );
};

export default YouthMinistryApp;
